# Next.js + Cloudflare Pages Starter

A modern Next.js scaffold that runs natively on [Cloudflare Pages](https://developers.cloudflare.com/pages/). It bundles Tailwind CSS 3, shadcn/ui, and TypeScript so you can move from idea to production quickly.

## Features

- **Next.js App Router** configured for TypeScript
- **Tailwind CSS 3** with shadcn/ui primitives and helper utilities
- **Cloudflare Pages ready** via [`@cloudflare/next-on-pages`](https://github.com/cloudflare/next-on-pages) and Wrangler scripts
- **Batteries included with D1 + R2** bindings pre-wired for database queries and object storage access on the Edge runtime
- **Strict linting** using `eslint-config-next`
- Example API route running on the Edge Runtime plus UI components to kickstart development

## Prerequisites

- [Node.js](https://nodejs.org/) 18 or later
- [pnpm](https://pnpm.io/) (Corepack is enabled in this project)

## Getting started

```bash
pnpm install
pnpm dev
```

Open <http://localhost:3000> to view the application.

## Available scripts

- `pnpm dev` ‚Äì start the Next.js development server
- `pnpm lint` ‚Äì run ESLint with the project configuration
- `pnpm build` ‚Äì create a production build
- `pnpm start` ‚Äì run the production server locally
- `pnpm cf:build` ‚Äì generate the Cloudflare Pages build output using `next-on-pages`
- `pnpm cf:preview` ‚Äì preview the Cloudflare Pages build locally with Wrangler

## Deploying to Cloudflare Pages

### Dashboard setup

1. Sign in to the [Cloudflare dashboard](https://dash.cloudflare.com/) and navigate to **Pages** ‚Üí **Create a project**.
2. Choose **Connect to Git** and authorize the Git provider that hosts this repository.
3. Select the repository for this project and keep the production branch as `main` (or whichever branch you want to deploy).
4. In the **Build settings** panel, set:
   - **Framework preset:** leave as **None** (Next.js is handled by `@cloudflare/next-on-pages`).
   - **Build command:** `pnpm cf:build`
   - **Build output directory:** `.vercel/output/static`
   - Expand **Functions** and set **Functions directory** to `.vercel/output/static/_worker.js` (the folder generated by `@cloudflare/next-on-pages`).
   - Ensure any dynamic routes or pages (including API routes) export `export const runtime = "edge";` so they are deployed as Cloudflare-compatible edge functions.
   - (Optional) Under **Environment variables**, add `NODE_VERSION=18` to match local development.
5. Save the configuration and click **Deploy site**. Cloudflare Pages will run the build command and publish the static assets and functions defined in the `.vercel/output` folder.
6. After the first deployment completes, open the project in the Pages dashboard, go to **Settings ‚Üí Functions ‚Üí Compatibility flags**, and add `nodejs_compat` to both the production and preview environments so Node.js built-ins used by Next.js are available at runtime.

### Connecting D1 and R2

This scaffold exposes bindings for Cloudflare [D1](https://developers.cloudflare.com/d1/) and [R2](https://developers.cloudflare.com/r2/) so you can work with relational data and object storage directly from the Edge runtime. The landing page renders the `/api/hello` endpoint and shows the binding status at build time, making it easy to confirm everything is wired up.

1. Create a D1 database and R2 bucket:

   ```bash
   wrangler d1 create nextjs-cloudflare-starter-db
   wrangler r2 bucket create nextjs-cloudflare-starter-assets
   ```

2. Tell Cloudflare Pages about the resources. Because this project uses `wrangler.toml`, the Pages dashboard shows the banner **‚ÄúBindings for this project are being managed through wrangler.toml‚Äù** and disables manual binding creation. Instead, commit the bindings to `wrangler.toml`:

   ```toml
   [[d1_databases]]
   binding = "DB"
   database_name = "nextjs-cloudflare-starter-db" # replace with your database name
   database_id = "00000000-0000-0000-0000-000000000000" # replace with your database ID

   [[r2_buckets]]
   binding = "R2"
   bucket_name = "nextjs-cloudflare-starter-assets" # replace with your bucket name
   ```

   - When creating resources with `wrangler`, copy the real `database_id` from the CLI output.
   - If you already deployed the project before adding bindings, trigger a new deployment so the Pages runtime receives the updated configuration.
3. (Optional) For local previews via `pnpm cf:preview`, you also need to run `wrangler login` once and ensure your `account_id` is set in `wrangler.toml` or available as the `CLOUDFLARE_ACCOUNT_ID` environment variable.
4. Re-run `pnpm cf:build` followed by `pnpm cf:preview` to test locally, or push to your Git provider to deploy.

The `/api/hello` route executes a `SELECT datetime('now')` statement against D1 and lists up to five object keys from R2. The homepage surfaces this response so you can quickly validate both integrations after each deployment.

### Local preview

The included `wrangler.toml` and `pnpm cf:preview` script let you test the same build locally before pushing to Git. Run:

```bash
pnpm cf:build
pnpm cf:preview
```

Wrangler will serve the output on <http://localhost:8788> so you can verify the Pages deployment bundle.

## Adding shadcn/ui components

Run the shadcn/ui CLI to scaffold additional components:

```bash
pnpm dlx shadcn-ui@latest add <component>
```

This repository already includes the `Button` component and the `cn` utility from shadcn/ui.

## Project structure

```
app/            # App Router pages and API routes
components/     # Reusable UI components (shadcn/ui)
lib/            # Shared utilities
public/         # Static assets
```

## Troubleshooting

- If `pnpm dev` fails with `Module not found: Can't resolve '@cloudflare/next-on-pages'`, ensure the dependencies have been
  installed by running `pnpm install` (or `pnpm install --frozen-lockfile` in CI) before starting the development server.

Happy shipping! üöÄ
